name: Validate Detections

on:
  workflow_dispatch:
    inputs:
      all:
        description: "Validate ALL detections (true/false)"
        required: false
        default: "false"
  push:
    branches: [ "main" ]
    paths:
      - "detections/**"
      - "pipelines/**"
      - ".github/workflows/validate.yml"
  pull_request:
    branches: [ "main" ]
    paths:
      - "detections/**"
      - "pipelines/**"
      - ".github/workflows/validate.yml"

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Bootstrap pip + install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r pipelines/requirements.txt

      - name: Determine detection files to validate
        id: files
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.all }}" == "true" ]]; then
            files=$(git ls-files 'detections/**/*.yml' 'detections/**/*.yaml' | tr '\n' ' ')
            echo "files=$files" >> "$GITHUB_OUTPUT"
            echo "Validating ALL detections."
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.sha }}"
          else
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
          fi

          changed=$(git diff --name-only "$base" "$head" -- 'detections/**/*.yml' 'detections/**/*.yaml' | tr '\n' ' ')
          if [[ -z "$changed" ]]; then
            echo "No detection files changed."
            echo "files=" >> "$GITHUB_OUTPUT"
          else
            echo "Changed detection files:"
            echo "$changed"
            echo "files=$changed" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate fields exist in Elasticsearch (staging)
        if: steps.files.outputs.files != ''
        env:
          ELASTICSEARCH_URL: ${{ secrets.ELASTICSEARCH_URL }}
          ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
          ELASTIC_USERNAME: ${{ secrets.ELASTIC_USERNAME }}
          ELASTIC_PASSWORD: ${{ secrets.ELASTIC_PASSWORD }}
        shell: bash
        run: |
          set -euo pipefail
          for f in ${{ steps.files.outputs.files }}; do
            echo "==> Field validation: $f"
            python pipelines/validate_fields.py \
              --rule "$f" \
              --es-url "${ELASTICSEARCH_URL}" \
              --api-key "${ELASTIC_API_KEY}" \
              --username "${ELASTIC_USERNAME}" \
              --password "${ELASTIC_PASSWORD}" \
              --insecure
          done

      - name: Dry-run detection queries (staging)
        if: steps.files.outputs.files != ''
        env:
          ELASTICSEARCH_URL: ${{ secrets.ELASTICSEARCH_URL }}
          ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          for f in ${{ steps.files.outputs.files }}; do
            echo "==> Dry-run query: $f"
            python pipelines/dry_run_detection.py \
              --rule "$f" \
              --es-url "${ELASTICSEARCH_URL}" \
              --api-key "${ELASTIC_API_KEY}" \
              --insecure
          done

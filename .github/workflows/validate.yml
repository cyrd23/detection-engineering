name: Validate Detections

on:
  push:
    branches: [ "main" ]
    paths:
      - "detections/**"
      - "pipelines/**"
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: [self-hosted, cicd-runner-01]

    env:
      ES_URL: ${{ secrets.ELASTICSEARCH_URL }}
      ES_USERNAME: ${{ secrets.ELASTIC_USERNAME }}
      ES_PASSWORD: ${{ secrets.ELASTIC_PASSWORD }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r pipelines/requirements.txt

      - name: Get changed detection files
        id: changes
        run: |
          git diff --name-only HEAD~1 HEAD | grep '^detections/.*\.yml$' > changed.txt || true

          if [ ! -s changed.txt ]; then
            echo "No detection changes found â€” running all."
            find detections -type f -name "*.yml" > changed.txt
          fi

          cat changed.txt

      - name: Field validation against Elasticsearch
        run: |
          while IFS= read -r rule; do
            echo "Validating fields for $rule"

            python pipelines/validate_fields.py \
              --rule "$rule" \
              --es-url "$ES_URL" \
              --api-key "$API_KEY" \
              --insecure \

              --rule "$rule" \
              --es-url "$ES_URL" \
              --username "$ES_USERNAME" \
              --password "$ES_PASSWORD" \
              --insecure

          done < changed.txt

      - name: Dry-run detection queries
        run: |
          while IFS= read -r rule; do
            echo "Dry run for $rule"

            python pipelines/dry_run.py \
              --rule "$rule" \
              --es-url "$ES_URL" \
              --username "$ES_USERNAME" \
              --password "$ES_PASSWORD" \
              --insecure

          done < changed.txt

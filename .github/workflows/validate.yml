name: Validate Detections

on:
  workflow_dispatch:
    inputs:
      all:
        description: "Validate ALL detections (true/false)"
        required: false
        default: "false"

  push:
    branches: [ "main" ]
    paths:
      - "detections/**"
      - "pipelines/**"
      - ".github/workflows/validate.yml"

  pull_request:
    branches: [ "main" ]
    paths:
      - "detections/**"
      - "pipelines/**"
      - ".github/workflows/validate.yml"

jobs:
  validate:
    runs-on: ubuntu-latest

    env:
      # Map repo secrets -> what scripts expect
      ELASTIC_URL: ${{ secrets.ELASTICSEARCH_URL }}
      ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
      ELASTIC_USERNAME: ${{ secrets.ELASTIC_USERNAME }}
      ELASTIC_PASSWORD: ${{ secrets.ELASTIC_PASSWORD }}
      KIBANA_URL: ${{ secrets.KIBANA_URL }}
      KIBANA_SPACE: ${{ secrets.KIBANA_SPACE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # critical for reliable diffing

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f pipelines/requirements.txt ]; then
            pip install -r pipelines/requirements.txt
          else
            # fallback: install commonly-needed deps
            pip install requests PyYAML elasticsearch
          fi

      - name: Debug env presence (no secrets printed)
        run: |
          python - <<'PY'
          import os
          keys = ["ELASTIC_URL","ELASTIC_API_KEY","ELASTIC_USERNAME","ELASTIC_PASSWORD","KIBANA_URL","KIBANA_SPACE"]
          for k in keys:
            print(f"{k}={'SET' if os.getenv(k) else 'MISSING'}")
          PY

      - name: Determine detection files to validate
        id: changed
        shell: bash
        run: |
          set -euo pipefail

          # Default: compute changed files based on the GitHub event
          CHANGED=""

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.sha }}"
            CHANGED="$(git diff --name-only "$BASE" "$HEAD" -- 'detections/**/*.yml' 'detections/**/*.yaml' || true)"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            # 'before' can be all zeros for some edge cases; handle gracefully
            if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
              CHANGED="$(git ls-files 'detections/**/*.yml' 'detections/**/*.yaml' || true)"
            else
              CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" -- 'detections/**/*.yml' 'detections/**/*.yaml' || true)"
            fi
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # if manually triggered, run based on input (see below)
            CHANGED=""
          fi

          # Manual override: validate all detections when workflow_dispatch input all=true
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.all }}" == "true" ]]; then
            CHANGED="$(git ls-files 'detections/**/*.yml' 'detections/**/*.yaml' || true)"
          fi

          echo "Changed detections:"
          echo "$CHANGED"

          # Export outputs
          {
            echo "files<<EOF"
            echo "$CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          # A boolean flag for conditions
          if [[ -n "${CHANGED// /}" ]]; then
            echo "any=true" >> "$GITHUB_OUTPUT"
          else
            echo "any=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate fields exist in Elasticsearch (staging)
        if: steps.changed.outputs.any == 'true'
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ steps.changed.outputs.files }}" | while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            echo "==> Field validation: $f"
            python pipelines/validate_fields.py \
              --rule "$f" \
              --es-url "$ELASTIC_URL" \
              --api-key "$ELASTIC_API_KEY" \
              --insecure
          done

      - name: Dry-run detection queries (staging)
        if: steps.changed.outputs.any == 'true'
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ steps.changed.outputs.files }}" | while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            echo "==> Dry-run: $f"
            python pipelines/dry_run_detection.py \
              --rule "$f" \
              --es-url "$ELASTIC_URL" \
              --api-key "$ELASTIC_API_KEY" \
              --insecure
          done

      - name: No detection files changed
        if: steps.changed.outputs.any != 'true'
        run: |
          echo "No detection YAML files changed; skipping validate + dry-run."

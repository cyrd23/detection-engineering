name: Validate Detections

on:
  push:
    branches: [ "main" ]
    paths:
      - "detections/**"
      - "pipelines/**"
      - ".github/workflows/validate.yml"

  workflow_dispatch:

jobs:
  validate:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Debug env presence (no secrets printed)
        run: |
          echo "ELASTICSEARCH_URL set: ${{ secrets.ELASTICSEARCH_URL != '' }}"
          echo "ELASTIC_API_KEY set: ${{ secrets.ELASTIC_API_KEY != '' }}"
          echo "ELASTIC_USERNAME set: ${{ secrets.ELASTIC_USERNAME != '' }}"
          echo "ELASTIC_PASSWORD set: ${{ secrets.ELASTIC_PASSWORD != '' }}"

      - name: Determine detection files to validate
        id: files
        shell: bash
        run: |
          set -euo pipefail

          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^detections/.*\.yml$' || true)

          if [ -z "$CHANGED" ]; then
            echo "No detection files changed."
            echo "files=" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED"
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Validate fields exist in Elasticsearch (staging)
        if: steps.files.outputs.files != ''
        shell: bash
        env:
          ES_URL: ${{ secrets.ELASTICSEARCH_URL }}
          API_KEY: ${{ secrets.ELASTIC_API_KEY }}
          ES_USER: ${{ secrets.ELASTIC_USERNAME }}
          ES_PASS: ${{ secrets.ELASTIC_PASSWORD }}
        run: |
          set -euo pipefail

          for RULE in ${{ steps.files.outputs.files }}; do
            echo "==> Field validation: $RULE"

            python pipelines/validate_fields.py \
              --rule "$RULE" \
              --es-url "$ES_URL" \
              --api-key "$API_KEY" \
              --username "$ES_USER" \
              --password "$ES_PASS" \
              --insecure
          done

      - name: Dry-run detection queries (staging)
        if: steps.files.outputs.files != ''
        shell: bash
        env:
          ES_URL: ${{ secrets.ELASTICSEARCH_URL }}
          API_KEY: ${{ secrets.ELASTIC_API_KEY }}
        run: |
          set -euo pipefail

          for RULE in ${{ steps.files.outputs.files }}; do
            echo "==> Dry run: $RULE"

            python pipelines/dry_run_detection.py \
              --rule "$RULE" \
              --es-url "$ES_URL" \
              --api-key "$API_KEY" \
              --insecure
          done

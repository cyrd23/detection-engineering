name: Validate Detections

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: [self-hosted, deteng-runner-1]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Bootstrap pip + install deps
        run: |
          python -m ensurepip --upgrade
          python -m pip install --upgrade pip
          pip install -r pipelines/requirements.txt

      # ðŸ‘‰ Field validation
      - name: Validate fields exist in Elasticsearch (staging)
        env:
          ES_URL: ${{ secrets.STAGING_ES_URL }}
          ES_USERNAME: ${{ secrets.STAGING_ES_USERNAME }}
          ES_PASSWORD: ${{ secrets.STAGING_ES_PASSWORD }}
          KIBANA_SPACE: detections-staging
        run: |
          python pipelines/validate_fields.py \
            --rule detections/entra/entra_risk_outside_us.yml \
            --es-url $ES_URL \
            --username $ES_USERNAME \
            --password $ES_PASSWORD \
            --kibana-space $KIBANA_SPACE

      # ðŸ‘‰ Query dry-run
      - name: Dry-run detection queries (staging)
        env:
          ES_URL: ${{ secrets.STAGING_ES_URL }}
          ES_USERNAME: ${{ secrets.STAGING_ES_USERNAME }}
          ES_PASSWORD: ${{ secrets.STAGING_ES_PASSWORD }}
        run: |
          python pipelines/dry_run_detection.py \
            --rule detections/entra/entra_risk_outside_us.yml \
            --es-url $ES_URL \
            --username $ES_USERNAME \
            --password $ES_PASSWORD
